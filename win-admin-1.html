<h1 id="windows-admin-scenario-high-cpu-usage-due-to-a-runaway-process-on-multiple-windows-servers">Windows Admin Scenario: High CPU Usage Due to a Runaway Process on Multiple Windows Servers</h1>

<h3 id="issue">Issue:</h3>

<p>A fleet of Windows Server 2019 EC2 instances started experiencing <strong>high CPU usage</strong>, causing degraded application performance. The root cause was an unresponsive <code class="language-plaintext highlighter-rouge">.NET</code> application process consuming excessive resources. Restarting the process manually was inefficient at scale.</p>

<hr />

<h2 id="1-powershell-script-for-automated-detection-and-recovery">1. PowerShell Script for Automated Detection and Recovery</h2>

<h3 id="script-goal">Script Goal:</h3>

<ul>
  <li>Identify processes consuming over 80% CPU.</li>
  <li>Automatically restart them.</li>
  <li>Log the event for audit purposes.</li>
  <li>Run across multiple servers using PowerShell Remoting.</li>
</ul>

<hr />

<h3 id="powershell-script">PowerShell Script:</h3>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Define parameters</span><span class="w">
</span><span class="nv">$ThresholdCPU</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">80</span><span class="w">
</span><span class="nv">$TargetProcess</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"MyApp.exe"</span><span class="w">
</span><span class="nv">$LogPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"C:\Logs\ProcessMonitor.log"</span><span class="w">
</span><span class="nv">$Servers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@(</span><span class="s2">"SERVER01"</span><span class="p">,</span><span class="w"> </span><span class="s2">"SERVER02"</span><span class="p">,</span><span class="w"> </span><span class="s2">"SERVER03"</span><span class="p">)</span><span class="w">  </span><span class="c"># Replace with real hostnames or pull from Active Directory</span><span class="w">

</span><span class="c"># Function to check and restart the process</span><span class="w">
</span><span class="kr">function</span><span class="w"> </span><span class="nf">Monitor-HighCPU</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="kr">param</span><span class="w"> </span><span class="p">(</span><span class="w">
        </span><span class="p">[</span><span class="n">string</span><span class="p">]</span><span class="nv">$ComputerName</span><span class="w">
    </span><span class="p">)</span><span class="w">

    </span><span class="kr">try</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="n">Invoke-Command</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="nv">$ComputerName</span><span class="w"> </span><span class="nt">-ScriptBlock</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="kr">param</span><span class="p">(</span><span class="nv">$TargetProcess</span><span class="p">,</span><span class="w"> </span><span class="nv">$ThresholdCPU</span><span class="p">,</span><span class="w"> </span><span class="nv">$LogPath</span><span class="p">)</span><span class="w">

            </span><span class="nv">$timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-Date</span><span class="w"> </span><span class="nt">-Format</span><span class="w"> </span><span class="s2">"yyyy-MM-dd HH:mm:ss"</span><span class="w">
            </span><span class="nv">$process</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-Process</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nv">$TargetProcess</span><span class="w"> </span><span class="nt">-ErrorAction</span><span class="w"> </span><span class="nx">SilentlyContinue</span><span class="w"> </span><span class="o">|</span><span class="w"> 
                       </span><span class="n">Sort-Object</span><span class="w"> </span><span class="nx">CPU</span><span class="w"> </span><span class="nt">-Descending</span><span class="w"> </span><span class="o">|</span><span class="w"> 
                       </span><span class="n">Select-Object</span><span class="w"> </span><span class="nt">-First</span><span class="w"> </span><span class="nx">1</span><span class="w">

            </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$process</span><span class="w"> </span><span class="o">-and</span><span class="w"> </span><span class="nv">$process</span><span class="o">.</span><span class="nf">CPU</span><span class="w"> </span><span class="o">-gt</span><span class="w"> </span><span class="nv">$ThresholdCPU</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nv">$logEntry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"</span><span class="nv">$timestamp</span><span class="s2"> | </span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">COMPUTERNAME</span><span class="s2"> | Restarting </span><span class="nv">$TargetProcess</span><span class="s2"> (CPU: </span><span class="si">$(</span><span class="nv">$process</span><span class="o">.</span><span class="nf">CPU</span><span class="si">)</span><span class="s2">%)"</span><span class="w">
                </span><span class="n">Add-Content</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="nv">$LogPath</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="nv">$logEntry</span><span class="w">
                </span><span class="n">Stop-Process</span><span class="w"> </span><span class="nt">-Id</span><span class="w"> </span><span class="nv">$process</span><span class="o">.</span><span class="nf">Id</span><span class="w"> </span><span class="nt">-Force</span><span class="w">
                </span><span class="n">Start-Process</span><span class="w"> </span><span class="nt">-FilePath</span><span class="w"> </span><span class="nv">$process</span><span class="o">.</span><span class="nf">Path</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w"> </span><span class="nt">-ArgumentList</span><span class="w"> </span><span class="nv">$TargetProcess</span><span class="p">,</span><span class="w"> </span><span class="nv">$ThresholdCPU</span><span class="p">,</span><span class="w"> </span><span class="nv">$LogPath</span><span class="w"> </span><span class="nt">-ErrorAction</span><span class="w"> </span><span class="n">Stop</span><span class="w">
    </span><span class="p">}</span><span class="w"> </span><span class="kr">catch</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="n">Write-Warning</span><span class="w"> </span><span class="s2">"Failed to connect to </span><span class="nv">$ComputerName</span><span class="s2">: </span><span class="bp">$_</span><span class="s2">"</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="c"># Loop through servers</span><span class="w">
</span><span class="kr">foreach</span><span class="w"> </span><span class="p">(</span><span class="nv">$HighCPU</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="nv">$server</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<hr />

<h3 id="requirements">Requirements:</h3>

<ul>
  <li>PowerShell Remoting enabled (<code class="language-plaintext highlighter-rouge">Enable-PSRemoting</code>)</li>
  <li>Proper firewall rules and credentials</li>
  <li>Your account must have permission to restart processes on remote machines</li>
</ul>

<hr />

<h3 id="example-log-output">Example Log Output:</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2025-07-18 10:33:05 | SERVER01 | Restarting MyApp.exe (CPU: 91.3%)
2025-07-18 10:33:12 | SERVER02 | Restarting MyApp.exe (CPU: 85.7%)
</code></pre></div></div>

<hr />

<h2 id="2-run-it-via-aws-systems-manager--run-command">2. Run It via AWS Systems Manager → <strong>Run Command</strong></h2>

<ol>
  <li>Go to <strong>AWS Console → Systems Manager → Run Command</strong></li>
  <li>Choose: <strong>AWS-RunPowerShellScript</strong></li>
  <li>Select target EC2 instances</li>
  <li>Paste the content of <code class="language-plaintext highlighter-rouge">HighCPURemediation.ps1</code> into the script box</li>
  <li>(Optional) Set output to <strong>CloudWatch Logs</strong></li>
</ol>

<hr />

<h2 id="3-schedule-it-with-state-manager-or-cloudwatch-events">3. Schedule It with <strong>State Manager</strong> or <strong>CloudWatch Events</strong></h2>

<p>To run this <strong>every 5 or 10 minutes</strong>:</p>

<h3 id="option-a-ssm-state-manager">Option A: <strong>SSM State Manager</strong></h3>

<ol>
  <li>Go to <strong>Systems Manager &gt; State Manager</strong></li>
  <li>
    <p>Create an association:</p>

    <ul>
      <li>Document: <code class="language-plaintext highlighter-rouge">AWS-RunPowerShellScript</code></li>
      <li>Target instances: choose tag-based or specific</li>
      <li>Schedule: <code class="language-plaintext highlighter-rouge">rate(5 minutes)</code></li>
      <li>Script Source: Upload or paste <code class="language-plaintext highlighter-rouge">HighCPURemediation.ps1</code></li>
    </ul>
  </li>
</ol>

<h3 id="option-b-cloudwatch-event-rule--ssm-automation">Option B: <strong>CloudWatch Event Rule + SSM Automation</strong></h3>

<ol>
  <li>
    <p>Create a rule:</p>

    <ul>
      <li>Event Source: Schedule → every 5 minutes</li>
      <li>Target: <strong>SSM Run Command</strong></li>
      <li>Document: <code class="language-plaintext highlighter-rouge">AWS-RunPowerShellScript</code></li>
      <li>Input: the script from above</li>
    </ul>
  </li>
</ol>

<hr />

<h2 id="4-optional-push-logs-to-cloudwatch">4. Optional: Push Logs to CloudWatch</h2>

<p>To push logs to CloudWatch:</p>

<ul>
  <li>Install the <strong>CloudWatch Agent</strong>.</li>
  <li>Configure it to collect <code class="language-plaintext highlighter-rouge">C:\SSM\CPUWatch.log</code>.</li>
</ul>

<p>Example JSON snippet in CloudWatch Agent config:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"logs"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"logs_collected"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"files"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"collect_list"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="nl">"file_path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"C:</span><span class="se">\\</span><span class="s2">SSM</span><span class="se">\\</span><span class="s2">CPUWatch.log"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"log_group_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/windows/highcpu"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"log_stream_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{instance_id}"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
