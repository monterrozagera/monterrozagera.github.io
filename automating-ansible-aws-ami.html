<h1 id="immutable-infrastructure-with-ansible-packer--terraform-on-aws">Immutable Infrastructure with Ansible, Packer &amp; Terraform on AWS</h1>

<p>Building secure and consistent infrastructure doesn’t end with baking an AMI — you need a scalable way to <strong>deploy</strong> it across environments. In this advanced follow-up, we’ll extend our previous AWS + Ansible AMI baking setup by using <strong>Terraform</strong> to:</p>

<ul>
  <li>Deploy infrastructure based on our <strong>prebaked AMIs</strong></li>
  <li>Automate <strong>networking, EC2 instances</strong>, and <strong>tags</strong></li>
  <li>Manage deployments as <strong>code with version control</strong></li>
</ul>

<hr />

<h2 id="workflow-overview">Workflow Overview</h2>

<ol>
  <li>Bake hardened AMIs with Ansible + Packer</li>
  <li>Upload to AWS with meaningful naming</li>
  <li>Use Terraform to <strong>deploy</strong> EC2 instances from baked AMIs</li>
</ol>

<hr />

<h2 id="directory-structure">Directory Structure</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aws-immutable-infra/
├── packer/
│   └── packer-template.json
├── ansible/
│   └── playbook.yml
├── terraform/
│   ├── main.tf
│   ├── variables.tf
│   └── outputs.tf
</code></pre></div></div>

<hr />

<h2 id="terraform-maintf">Terraform: main.tf</h2>

<p>This file deploys an EC2 instance using the <strong>latest baked AMI</strong> filtered by name and tag.</p>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">provider</span> <span class="s2">"aws"</span> <span class="p">{</span>
  <span class="nx">region</span> <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">aws_region</span>
<span class="p">}</span>

<span class="nx">data</span> <span class="s2">"aws_ami"</span> <span class="s2">"secure_ami"</span> <span class="p">{</span>
  <span class="nx">most_recent</span> <span class="o">=</span> <span class="kc">true</span>
  <span class="nx">owners</span>      <span class="o">=</span> <span class="p">[</span><span class="s2">"self"</span><span class="p">]</span>

  <span class="nx">filter</span> <span class="p">{</span>
    <span class="nx">name</span>   <span class="o">=</span> <span class="s2">"name"</span>
    <span class="nx">values</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"secure-ami-*"</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_instance"</span> <span class="s2">"hardened_ec2"</span> <span class="p">{</span>
  <span class="nx">ami</span>                         <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">aws_ami</span><span class="p">.</span><span class="nx">secure_ami</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">instance_type</span>               <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">instance_type</span>
  <span class="nx">subnet_id</span>                   <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">subnet_id</span>
  <span class="nx">associate_public_ip_address</span> <span class="o">=</span> <span class="kc">true</span>

  <span class="nx">vpc_security_group_ids</span> <span class="o">=</span> <span class="p">[</span><span class="nx">var</span><span class="p">.</span><span class="nx">security_group_id</span><span class="p">]</span>
  <span class="nx">key_name</span>               <span class="o">=</span> <span class="nx">var</span><span class="p">.</span><span class="nx">key_name</span>

  <span class="nx">tags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">Name</span>        <span class="o">=</span> <span class="s2">"SecureInstance"</span>
    <span class="nx">Environment</span> <span class="o">=</span> <span class="s2">"Production"</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h2 id="variablestf">variables.tf</h2>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">variable</span> <span class="s2">"aws_region"</span> <span class="p">{</span>
  <span class="nx">default</span> <span class="o">=</span> <span class="s2">"us-west-2"</span>
<span class="p">}</span>

<span class="nx">variable</span> <span class="s2">"instance_type"</span> <span class="p">{</span>
  <span class="nx">default</span> <span class="o">=</span> <span class="s2">"t2.micro"</span>
<span class="p">}</span>

<span class="nx">variable</span> <span class="s2">"subnet_id"</span> <span class="p">{}</span>
<span class="nx">variable</span> <span class="s2">"security_group_id"</span> <span class="p">{}</span>
<span class="nx">variable</span> <span class="s2">"key_name"</span> <span class="p">{}</span>
</code></pre></div></div>

<hr />

<h2 id="outputstf">outputs.tf</h2>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">output</span> <span class="s2">"instance_public_ip"</span> <span class="p">{</span>
  <span class="nx">value</span> <span class="o">=</span> <span class="nx">aws_instance</span><span class="p">.</span><span class="nx">hardened_ec2</span><span class="p">.</span><span class="nx">public_ip</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h2 id="security-group-and-subnet-example-optional">Security Group and Subnet Example (Optional)</h2>

<p>If you don’t already have infrastructure to plug into, you can add:</p>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">resource</span> <span class="s2">"aws_vpc"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">cidr_block</span> <span class="o">=</span> <span class="s2">"10.0.0.0/16"</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_subnet"</span> <span class="s2">"main"</span> <span class="p">{</span>
  <span class="nx">vpc_id</span>     <span class="o">=</span> <span class="nx">aws_vpc</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">cidr_block</span> <span class="o">=</span> <span class="s2">"10.0.1.0/24"</span>
<span class="p">}</span>

<span class="nx">resource</span> <span class="s2">"aws_security_group"</span> <span class="s2">"ssh_only"</span> <span class="p">{</span>
  <span class="nx">name</span>        <span class="o">=</span> <span class="s2">"allow_ssh"</span>
  <span class="nx">description</span> <span class="o">=</span> <span class="s2">"Allow SSH"</span>
  <span class="nx">vpc_id</span>      <span class="o">=</span> <span class="nx">aws_vpc</span><span class="p">.</span><span class="nx">main</span><span class="p">.</span><span class="nx">id</span>

  <span class="nx">ingress</span> <span class="p">{</span>
    <span class="nx">from_port</span>   <span class="o">=</span> <span class="mi">22</span>
    <span class="nx">to_port</span>     <span class="o">=</span> <span class="mi">22</span>
    <span class="nx">protocol</span>    <span class="o">=</span> <span class="s2">"tcp"</span>
    <span class="nx">cidr_blocks</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"0.0.0.0/0"</span><span class="p">]</span>
  <span class="p">}</span>

  <span class="nx">egress</span> <span class="p">{</span>
    <span class="nx">from_port</span>   <span class="o">=</span> <span class="mi">0</span>
    <span class="nx">to_port</span>     <span class="o">=</span> <span class="mi">0</span>
    <span class="nx">protocol</span>    <span class="o">=</span> <span class="s2">"-1"</span>
    <span class="nx">cidr_blocks</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"0.0.0.0/0"</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h2 id="full-flow-bake-and-deploy">Full Flow: Bake and Deploy</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Step 1: Bake AMI</span>
<span class="nb">cd </span>packer
packer build packer-template.json

<span class="c"># Step 2: Deploy infrastructure</span>
<span class="nb">cd</span> ../terraform
terraform init
terraform apply <span class="nt">-auto-approve</span> <span class="se">\</span>
  <span class="nt">-var</span> <span class="s1">'subnet_id=subnet-xxxx'</span> <span class="se">\</span>
  <span class="nt">-var</span> <span class="s1">'security_group_id=sg-xxxx'</span> <span class="se">\</span>
  <span class="nt">-var</span> <span class="s1">'key_name=my-ssh-key'</span>
</code></pre></div></div>

<hr />

<h2 id="why-this-is-powerful">Why This Is Powerful</h2>

<ul>
  <li><strong>Consistency</strong>: AMI is configured once, reused many times.</li>
  <li><strong>Security</strong>: Hardened at the image level before deployment.</li>
  <li><strong>Reproducibility</strong>: Deploy the same infra with the same config.</li>
  <li><strong>Auditing</strong>: Infrastructure changes are tracked in Git.</li>
</ul>

<hr />

<h2 id="bonus-ideas">Bonus Ideas</h2>

<ul>
  <li>Add <strong>Ansible roles</strong> for vulnerability scanning (e.g. OpenSCAP).</li>
  <li>Use <strong>Terraform Cloud</strong> or <strong>GitHub Actions</strong> for CI/CD.</li>
  <li>Register your AMI in <strong>multiple regions</strong> using <code class="language-plaintext highlighter-rouge">aws_ami_copy</code>.</li>
</ul>

<hr />

<h2 id="summary">Summary</h2>

<p>By combining <strong>Ansible + Packer + Terraform</strong>, you get a fully automated and secure path from configuration to deployment — the foundation of immutable, production-grade infrastructure on AWS.</p>
